<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<link href="stylesheets/reset.css" rel="stylesheet" type="text/css" />
		<link href="stylesheets/main.css" rel="stylesheet" type="text/css" />
		<script src="javascripts/mootools-core-1.3.2.js" type="text/javascript"></script>
		<script src="javascripts/mootools-more-1.3.2.1.js" type="text/javascript"></script>
		<script src="javascripts/paper-0.21.js" type="text/javascript"></script>

		<title>Loki</title>
	</head>
	<body>
    <div class="canvas"><canvas resize="true" id="display" style="background: black;"></canvas></div>

<script src="http://localhost:4200/socket.io/socket.io.js"></script>
<script>
  var Client = new Class({
    socket: null,
    canvas: null,
    items: {
      players: {}
    },
    gameState: {},
    
    keys: {
      'w': 'up',
      'a': 'left',
      's': 'down',
      'd': 'right'
    },
    
    initialize: function () {
      this.initializeSocket();
      this.addSocketListeners();
      
      this.initializeDisplay();
      this.addInputListeners();
    },
    
    initializeSocket: function () {
      this.socket = io.connect('http://localhost:4200');
    },
    
    initializeDisplay: function () {
      this.canvas = document.id('display');
      this.paper = new paper.PaperScope();
      this.paper.setup(this.canvas);
    },
    
    addSocketListeners: function () {
      this.socket.on('log in prompt', function (data) {

        // motd
        alert(data.message);

        // login prompt
        var name = prompt('Name:', '');
        if (name) this.socket.emit('log in', { name: name });
      }.bind(this));

      this.socket.on('game state', function (data) {
        this.updateGame(data);
      }.bind(this));
    },
    
    addInputListeners: function () {
      document.addEvent('keypress', function (ev) {
        ev.stopPropagation();
        direction = this.keys[ev.key];
        if (direction) {
          this.socket.emit('move', { direction: direction, value: 10 });
        }
      }.bind(this));
      
      this.canvas.addEvent('click', function (ev) {
        ev.stopPropagation();
        this.socket.emit('move to', { x: ev.client.x, y: ev.client.y })
      }.bind(this));
    },
    
    updateGame: function (data) {
      // store game state
      this.gameState = data;
      
      // (re)draw game
      this.draw();
    },
    
    // (re)draw the game
    draw: function () {
      this.cleanItems();
      this.drawPlayers();
      this.paper.view.draw();
    },
    
    // (re)draws all players based on current game state
    drawPlayers: function () {
      // go through players in game state and (re)draw them
      Object.each(this.gameState.players, this.drawPlayer.bind(this));
    },
    
    // draw player with given data
    drawPlayer: function (data) {
      // get stored player item if we have one
      var player = this.items.players[data.name];
      
      // create player sprite if we don't have one yet
      if (!player) {
        player = new this.paper.Path.Circle(new this.paper.Point(data.x, data.y), 25);
        var colors = ['green', 'red', 'blue', 'yellow', 'purple', 'teal'];
        player.fillColor = colors[Math.floor(Math.random() * colors.length)];
        this.paper.project.activeLayer.addChild(player);
      }
      
      // update player sprite
      player.position.x = data.x;
      player.position.y = data.y;
      
      // store player item
      this.items.players[data.name] = player;
    },
    
    // removes items that are no longer references in the game state
    cleanItems: function () {
      this.cleanPlayers();
    },
    
    // removes players that are no longer references in the game state
    cleanPlayers: function () {
      console.log(this.items.players);
      Object.each(this.items.players, function (player, name) {
        if (!this.gameState.players[name]) {
          this.items.players[name].remove();
          delete this.items.players[name];
        }
      }.bind(this));
      console.log(this.items.players);
    }
  });
  
  var client = new Client();
</script>
	</body>
</html>